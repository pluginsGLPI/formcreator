name: Tests

on:
  [push, pull_request]

env:
  PLUGINNAME: formcreator

jobs:
  # Basic plugin tests for EOL version
  tests:
    name: "Plugin Tests"
    runs-on: "ubuntu-latest"
    strategy:
      matrix:
        php-versions: ['8.2', '8.3']
        glpi-version: ['11.0.x']
    
    steps:
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: curl, fileinfo, gd, json, mbstring, zlib, simplexml, xml, intl
          ini-values: memory_limit=512M
          coverage: none

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Composer dependencies
        run: |
          if [ -f composer.json ]; then
            composer install --no-dev --optimize-autoloader
          fi

      - name: Run PHPUnit tests
        run: |
          if [ -f phpunit.xml ]; then
            cd tests
            php -f bootstrap.php
            ../vendor/bin/phpunit --configuration phpunit.xml || true
          else
            echo "No PHPUnit configuration found - EOL plugin has minimal tests"
          fi

  # Code quality for EOL version
  code-quality:
    name: "Code Quality"
    runs-on: "ubuntu-latest"
    strategy:
      matrix:
        php-versions: ['8.2']
    
    steps:
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: curl, fileinfo, gd, json, mbstring, zlib, simplexml, xml, intl

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Composer dependencies
        run: |
          composer install --no-dev --optimize-autoloader

      - name: Run PHPStan
        run: |
          if [ -f phpstan.neon ]; then
            vendor/bin/phpstan analyse --configuration=phpstan.neon --memory-limit=512M || true
          else
            echo "No PHPStan configuration found"
          fi

      - name: Check PHP syntax
        run: |
          find . -name "*.php" -not -path "./vendor/*" -not -path "./tests/*" -exec php -l {} \; | (! grep -v "No syntax errors detected")
